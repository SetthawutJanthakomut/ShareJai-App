<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ShareJai</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    window.lucideReact = {};
    if (window.lucide && window.lucide.icons) {
      Object.keys(window.lucide.icons).forEach(key => {
        const iconData = window.lucide.icons[key];
        window.lucideReact[key] = React.forwardRef(({ color = "currentColor", size = 24, strokeWidth = 2, className = "", ...props }, ref) => {
          return React.createElement(
            "svg",
            {
              ref,
              ...props,
              xmlns: "http://www.w3.org/2000/svg",
              width: size,
              height: size,
              viewBox: "0 0 24 24",
              fill: "none",
              stroke: color,
              strokeWidth: strokeWidth,
              strokeLinecap: "round",
              strokeLinejoin: "round",
              className: `lucide lucide-${key.replace(/([A-Z])/g, '-$1').toLowerCase().replace(/^-/, '')} ${className}`.trim()
            },
            ...iconData.map(([tag, attrs, children]) => React.createElement(tag, { ...attrs, key: Math.random() }, children))
          );
        });
        window.lucideReact[key].displayName = key;
      });
      window.lucideReact = new Proxy(window.lucideReact, {
        get: (target, prop) => target[prop] || (() => null)
      });
    }
  </script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');
    body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .animate-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
 const { 
  Plus, Trash2, Edit2, History, Wallet, Calendar, Users, 
  Calculator, ArrowRight, Save, X, HandCoins, ArrowLeftRight, 
  CheckCircle2, Settings, AlertTriangle, PlusCircle, MinusCircle, 
  Sparkles, UserCircle, Eye, Mail, Tag, BarChart3, PieChart,
  ChevronLeft, ChevronRight, Filter, Clock, Paperclip, FileText, 
  Image: ImageIcon, Upload, Percent, Search // <--- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Search ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
} = window.lucideReact;

    const App = () => {
      const [isLoading, setIsLoading] = useState(true);
      const [users, setUsers] = useState([]);
      const [currentUser, setCurrentUser] = useState(null);
      const [categories, setCategories] = useState([]);
      const [expenses, setExpenses] = useState([]);
      const [logs, setLogs] = useState([]);
      
      const [activeTab, setActiveTab] = useState('expenses'); 
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [editingId, setEditingId] = useState(null);
      const [viewingAttachments, setViewingAttachments] = useState(null);
      const [viewDate, setViewDate] = useState(new Date());
      const [categoryViewMode, setCategoryViewMode] = useState('total');
      const [filterMode, setFilterMode] = useState('all');
      const [filterDate, setFilterDate] = useState(new Date().toISOString().split('T')[0]);
      const [showBudgetConfig, setShowBudgetConfig] = useState(false);
      const [budgetRules, setBudgetRules] = useState([]);

      const [formData, setFormData] = useState({
        title: '', amount: '', payer: '', type: 'shared', split: 50, 
        category: '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', note: '', date: new Date().toISOString().split('T')[0], 
        attachments: [], 
        months: 10, // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        relatedInstallments: [] // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ
      });
      const [userFormData, setUserFormData] = useState({ id: null, name: '', email: '' });
      const [categoryFormData, setCategoryFormData] = useState('');
      const [isUserModalOpen, setIsUserModalOpen] = useState(false);
      const [isCategoryModalOpen, setIsCategoryModalOpen] = useState(false);
      
      const historyTitles = useMemo(() => {
         const titles = expenses.map(e => e.title).filter(t => t); 
         return [...new Set(titles)]; 
      }, [expenses]);
      
      const [isUnauthorized, setIsUnauthorized] = useState(false);
      const [myEmail, setMyEmail] = useState('');
      const [isInstallmentExpanded, setIsInstallmentExpanded] = useState(false); 
      const [isBudgetExpanded, setIsBudgetExpanded] = useState(false);
      const [isCategoryExpanded, setIsCategoryExpanded] = useState(false);

      useEffect(() => {
        if (typeof google !== 'undefined' && google.script) {
          google.script.run.withSuccessHandler((data) => {
            setUsers(data.users);
            setCategories(data.categories);
            setExpenses(data.expenses);
            setBudgetRules(data.budgetRules);
            setLogs(data.logs);

const email = data.activeEmail;
            setMyEmail(email);

            if (email) {
               // üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)
               const foundUser = data.users.find(u => {
                   if (!u.email) return false;
                   // ‡πÅ‡∏¢‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏î‡πâ‡∏ß‡∏¢ , ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å
                   const allowedEmails = u.email.split(',').map(e => e.trim().toLowerCase());
                   // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ (email) ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏´‡∏°
                   return allowedEmails.includes(email.toLowerCase());
               });

               if (foundUser) {
                  setCurrentUser(foundUser);
                  setFormData(prev => ({ ...prev, payer: foundUser.name }));
               } else {
                  setIsUnauthorized(true);
               }
            } else {
               console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏≠‡∏≤‡∏à‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Deploy ‡πÄ‡∏õ‡πá‡∏ô Execute as Me)");
               setCurrentUser(data.users[0]); 
               setFormData(prev => ({ ...prev, payer: data.users[0]?.name }));
            }
            setIsLoading(false);
          }).getInitialData();
        } else {
          setIsLoading(false);
        }
      }, []);

      const syncTransaction = (data) => {
         google.script.run
            .withFailureHandler((err) => {
               alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
            })
            .saveTransaction(data);
      };

      const syncDelete = (id) => google.script.run.deleteTransaction(id);
      
      const syncLog = (log) => {
         google.script.run
            .withFailureHandler((err) => console.error("Log failed", err))
            .saveLog(log);
      };
      
      const syncUsers = (newUsers) => google.script.run.saveUsers(newUsers);
      const syncCategory = (cat) => google.script.run.saveCategory(cat);
      const syncDeleteCategory = (cat) => google.script.run.deleteCategory(cat);
      const syncBudgetRules = (rules) => google.script.run.saveBudgetRules(rules);

      const formatMoney = (amount) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(amount);
      
      const addLog = (action, title, amount, payer) => {
        const detail = amount 
          ? `"${title}" (${formatMoney(amount)}) ‡πÇ‡∏î‡∏¢ ${payer}`
          : `"${title}"`;
        const newLog = {
          id: Date.now().toString(),
          timestamp: new Date().toISOString(), 
          action,
          detail,
          actor: currentUser ? currentUser.name : 'Unknown'
        };
        setLogs(prev => [newLog, ...prev]);
        syncLog(newLog);
      };

      const detectCategory = (title) => {
        const t = title.toLowerCase();
        const sortedCats = [...categories].sort((a, b) => b.length - a.length);
        const matchedCat = sortedCats.find(cat => t.includes(cat.toLowerCase()));
        if (matchedCat) return matchedCat;
        if (t.includes('‡∏õ‡∏±‡πä‡∏°') || t.includes('gas') || t.includes('ptt') || t.includes('shell')) return '‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô';
        if (t.includes('‡∏Ç‡πâ‡∏≤‡∏ß') || t.includes('‡∏≠‡∏≤‡∏´‡∏≤‡∏£') || t.includes('mk') || t.includes('buffet') || t.includes('suki') || t.includes('shabu')) return '‡∏≠‡∏≤‡∏´‡∏≤‡∏£';
        if (t.includes('‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô') || t.includes('bts') || t.includes('mrt') || t.includes('grab') || t.includes('taxi')) return '‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á';
        if (t.includes('‡∏Å‡∏≤‡πÅ‡∏ü') || t.includes('cafe') || t.includes('coffee') || t.includes('starbucks') || t.includes('amazon') || t.includes('‡∏ä‡∏≤')) return '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°';
        if (t.includes('‡∏´‡∏ô‡∏±‡∏á') || t.includes('cinema') || t.includes('netflix') || t.includes('game')) return '‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á';
        if (t.includes('‡πÑ‡∏ü') || t.includes('‡∏õ‡∏£‡∏∞‡∏õ‡∏≤') || t.includes('‡πÄ‡∏ô‡πá‡∏ï') || t.includes('wifi')) return '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü';
        if (t.includes('‡πÄ‡∏ä‡πà‡∏≤') || t.includes('‡∏´‡πâ‡∏≠‡∏á') || t.includes('condo') || t.includes('‡∏ö‡πâ‡∏≤‡∏ô') || t.includes('‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á')) return '‡∏Ñ‡πà‡∏≤‡∏ö‡πâ‡∏≤‡∏ô';
        if (t.includes('‡∏á‡∏ß‡∏î') || t.includes('‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô') || t.includes('‡∏û‡∏£‡∏ö') || t.includes('‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏ñ')) return '‡∏Ñ‡πà‡∏≤‡∏£‡∏ñ';
        return null;
      };

      const resetForm = () => {
        setFormData({
          title: '', amount: '', payer: currentUser ? currentUser.name : '', 
          type: 'shared', split: 50, category: categories[0] || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', 
          note: '', date: new Date().toISOString().split('T')[0], 
          attachments: [], months: 10, relatedInstallments: [] // ‚úÖ Reset ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà
        });
        setEditingId(null);
        setSelectedCycles([]); // Reset ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á
      };
      const handleFileChange = async (e) => {
        const files = Array.from(e.target.files);
        const newAttachments = await Promise.all(files.map(file => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve({ name: file.name, type: file.type, data: reader.result });
            reader.onerror = error => reject(error);
          });
        }));
        setFormData(prev => ({ ...prev, attachments: [...prev.attachments, ...newAttachments] }));
      };

      const removeAttachment = (index) => {
        setFormData(prev => ({ ...prev, attachments: prev.attachments.filter((_, i) => i !== index) }));
      };

      const getCycleRange = (dateInput) => {
        const date = new Date(dateInput);
        const day = date.getDate();
        const month = date.getMonth();
        const year = date.getFullYear();
        let startDate, endDate, cycleName;
        if (day >= 5) {
          startDate = new Date(year, month, 5);
          endDate = new Date(year, month + 1, 4, 23, 59, 59); 
          const nextMonthDate = new Date(year, month + 1, 1);
          cycleName = `‡∏£‡∏≠‡∏ö 5 ${date.toLocaleString('th-TH', { month: 'short' })} - 4 ${nextMonthDate.toLocaleString('th-TH', { month: 'short' })}`;
        } else {
          startDate = new Date(year, month - 1, 5);
          endDate = new Date(year, month, 4, 23, 59, 59); 
          const prevMonthDate = new Date(year, month - 1, 1);
          cycleName = `‡∏£‡∏≠‡∏ö 5 ${prevMonthDate.toLocaleString('th-TH', { month: 'short' })} - 4 ${date.toLocaleString('th-TH', { month: 'short' })}`;
        }
        return { startDate, endDate, cycleName };
      };

      const currentCycleInfo = useMemo(() => getCycleRange(viewDate), [viewDate]);

      const changeCycle = (months) => {
        const newDate = new Date(viewDate);
        newDate.setMonth(newDate.getMonth() + months);
        setViewDate(newDate);
      };

// --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic Calculation ‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏î‡∏Å‡∏é Budget ‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏£‡∏ß‡∏°) ---
const calculation = useMemo(() => {
    if (!users.length) return { totalShared: 0, splitAmount: 0, stats: {}, prevStats: {}, globalStats: {}, adjustedPrevStats: {}, budgetStatus: [], sortedCategories: [] };
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° "‡∏£‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" (Cycle)
    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏î Budget Rule ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏ï‡∏µ‡∏Å‡∏±‡∏ô
    const cyclesData = {}; 

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    const initData = () => {
        const s = {};
        users.forEach(u => s[u.name] = { paid: 0, cost: 0, personal: 0, advanceDebt: 0, transferIn: 0, transferOut: 0, netBalance: 0, installmentPayment: 0 });
        return { stats: s, categoryTotals: {}, categoryPaid: {}, categoryStats: {} };
    };

    let totalShared = 0; // ‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡∏´‡∏≤‡∏£‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏µ‡∏™‡πâ‡∏°‡πÉ‡∏´‡∏ç‡πà‡πÜ)
    
    // 1. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏≠‡∏î‡∏•‡∏á‡∏ñ‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
    expenses.forEach(exp => {
        const { cycleName } = getCycleRange(exp.date);
        
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ñ‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
        if (!cyclesData[cycleName]) {
            cyclesData[cycleName] = initData();
             // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (sortedCategories)
            categories.forEach(c => {
                cyclesData[cycleName].categoryStats[c] = { total: 0, users: {} };
                users.forEach(u => cyclesData[cycleName].categoryStats[c].users[u.name] = 0);
            });
        }
        
        const cycle = cyclesData[cycleName];
        const val = parseFloat(exp.amount);
        const payerName = exp.payer;

        // ‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
        if (exp.type === 'installment') return;

        // --- Logic ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (Transfer) ---
        if (exp.type === 'transfer') {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô (‡∏°‡∏µ relatedId)
            if (exp.relatedId) {
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡πà‡∏ß‡πà‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡∏Ç‡∏¢‡∏±‡∏ö)
                if (cycle.stats[payerName]) {
                    cycle.stats[payerName].installmentPayment = (cycle.stats[payerName].installmentPayment || 0) + val;
                }
                // ‚úÖ return ‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ô‡∏≥‡πÑ‡∏õ‡∏Ñ‡∏¥‡∏î‡πÉ‡∏ô Net Balance" (‡πÅ‡∏¢‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤)
                return; 
            }

            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
            const receiver = users.find(u => u.name !== payerName)?.name;
            if (receiver) {
               cycle.stats[payerName].transferOut += val;
               cycle.stats[receiver].transferIn += val;
            }
            return;
        }

        // --- Logic ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ---
        if (cycle.stats[payerName]) cycle.stats[payerName].paid += val;

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ Budget Rule ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
        cycle.categoryTotals[exp.category] = (cycle.categoryTotals[exp.category] || 0) + val;
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Logic ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô)
        if (!cycle.categoryPaid[exp.category]) cycle.categoryPaid[exp.category] = {};
        if (!cycle.categoryPaid[exp.category][payerName]) cycle.categoryPaid[exp.category][payerName] = 0;
        cycle.categoryPaid[exp.category][payerName] += val;

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏é‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const rule = budgetRules.find(r => r.category === exp.category);

        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏é ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô (‡∏£‡∏≠‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≠‡∏ô‡∏à‡∏ö) ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà
        if (rule) {
            if (exp.type === 'shared') {
                 if (cycleName === currentCycleInfo.cycleName) totalShared += val;
                 // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏ß‡∏Å cost ‡πÉ‡∏™‡πà stats ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡∏£‡∏≠‡πÑ‡∏õ‡∏ö‡∏ß‡∏Å‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ limit
            }
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏é ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Standard Split)
            if (exp.type === 'shared') {
                 if (cycleName === currentCycleInfo.cycleName) totalShared += val;
                 
                 // ‡∏ö‡∏ß‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ Total ‡∏Ç‡∏≠‡∏á Category Stats (‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á)
                 if (cycle.categoryStats[exp.category]) cycle.categoryStats[exp.category].total += val;

                 const split = exp.split !== undefined ? exp.split : 50;
                 const share0 = val * (split / 100);
                 const share1 = val - share0;
                 
                 if(users[0]) {
                     cycle.stats[users[0].name].cost += share0;
                     if(cycle.categoryStats[exp.category]) cycle.categoryStats[exp.category].users[users[0].name] += share0;
                 }
                 if(users[1]) {
                     cycle.stats[users[1].name].cost += share1;
                     if(cycle.categoryStats[exp.category]) cycle.categoryStats[exp.category].users[users[1].name] += share1;
                 }

            } else if (exp.type === 'personal') {
                 cycle.stats[payerName].cost += val;
                 cycle.stats[payerName].personal += val;
                 if(cycle.categoryStats[exp.category]) {
                     cycle.categoryStats[exp.category].total += val;
                     cycle.categoryStats[exp.category].users[payerName] += val;
                 }

            } else if (exp.type === 'advance') {
                 const others = users.filter(u => u.name !== payerName);
                 others.forEach(u => { 
                    const share = val / others.length;
                    cycle.stats[u.name].cost += share; 
                    cycle.stats[u.name].advanceDebt += share;
                    if(cycle.categoryStats[exp.category]) {
                        cycle.categoryStats[exp.category].total += val;
                        cycle.categoryStats[exp.category].users[u.name] += share;
                    }
                 });
            }
        }
    });

    // 2. ‡∏à‡∏ö‡∏•‡∏π‡∏õ: ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Budget Rules ‡∏Ç‡∏≠‡∏á "‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô
    Object.keys(cyclesData).forEach(cName => {
        const cycle = cyclesData[cName];
        
        budgetRules.forEach(rule => {
             const catTotal = cycle.categoryTotals[rule.category] || 0;
             if (catTotal === 0) return;

             let ownerCost = 0, excessCost = 0;
             if (catTotal <= rule.limit) {
                 ownerCost = catTotal;
             } else {
                 ownerCost = rule.limit;
                 excessCost = catTotal - rule.limit;
             }

             // ‡∏ö‡∏ß‡∏Å cost ‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô
             if (cycle.stats[rule.owner]) cycle.stats[rule.owner].cost += ownerCost;
             if (cycle.stats[rule.excessPayer]) cycle.stats[rule.excessPayer].cost += excessCost;

             // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (CategoryStats) ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏é
             if (cycle.categoryStats[rule.category]) {
                 cycle.categoryStats[rule.category].total = catTotal;
                 // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏¢‡∏≠‡∏î user ‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏Å‡∏é
                 users.forEach(u => cycle.categoryStats[rule.category].users[u.name] = 0);
                 if(users.find(u => u.name === rule.owner)) cycle.categoryStats[rule.category].users[rule.owner] += ownerCost;
                 if(users.find(u => u.name === rule.excessPayer)) cycle.categoryStats[rule.category].users[rule.excessPayer] += excessCost;
             }
        });
    });

    // 3. ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î: ‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" (stats) ‡πÅ‡∏•‡∏∞ "‡∏≠‡∏î‡∏µ‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" (prevStats)
    const currentStats = initData().stats;
    const previousStats = initData().stats;
    let budgetStatus = [];
    let sortedCategories = [];

    Object.keys(cyclesData).forEach(cName => {
        const cycle = cyclesData[cName];
        
        if (cName === currentCycleInfo.cycleName) {
            // --- ‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ---
            // ‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡πÉ‡∏™‡πà currentStats
            users.forEach(u => {
                Object.keys(currentStats[u.name]).forEach(key => {
                    currentStats[u.name][key] = cycle.stats[u.name][key];
                });
            });

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Budget Status ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏•‡∏≠‡∏î‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß/‡πÅ‡∏î‡∏á
             budgetRules.forEach(rule => {
                const catTotal = cycle.categoryTotals[rule.category] || 0;
                let excessAmount = catTotal > rule.limit ? catTotal - rule.limit : 0;
                let isExceeded = catTotal > rule.limit;
                const excessPayerPaidAmount = cycle.categoryPaid[rule.category]?.[rule.excessPayer] || 0;
                const excessPayerNet = excessAmount - excessPayerPaidAmount;
                budgetStatus.push({ ...rule, total: catTotal, excess: excessAmount, isExceeded, excessPayerPaid: excessPayerPaidAmount, excessPayerNet });
            });

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
            sortedCategories = Object.entries(cycle.categoryStats)
               .filter(([_, data]) => data.total > 0)
               .sort((a, b) => b[1].total - a[1].total);

        } else {
            // --- ‡∏£‡∏≠‡∏ö‡πÄ‡∏Å‡πà‡∏≤ (‡∏≠‡∏î‡∏µ‡∏ï) ---
            // ‡∏™‡∏∞‡∏™‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ previousStats
            users.forEach(u => {
                Object.keys(previousStats[u.name]).forEach(key => {
                    previousStats[u.name][key] += cycle.stats[u.name][key];
                });
            });
        }
    });

    // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Net Balance (‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏î‡∏¥‡∏°)
    const calcNet = (s) => (s.paid + s.transferOut) - (s.cost + s.transferIn);
    
    users.forEach(u => {
       currentStats[u.name].netBalance = calcNet(currentStats[u.name]);
       previousStats[u.name].netBalance = calcNet(previousStats[u.name]);
       currentStats[u.name].netBalanceNoTransfer = currentStats[u.name].paid - currentStats[u.name].cost;
    });

    const globalStats = {};
    const adjustedPrevStats = {};

    users.forEach(u => {
        globalStats[u.name] = {
            netBalance: currentStats[u.name].netBalance + previousStats[u.name].netBalance
        };

        // adjustedPrevStats: ‡πÄ‡∏≠‡∏≤‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡πÑ‡∏õ‡∏´‡∏±‡∏Å‡∏•‡∏ö‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πà‡∏≤
        // (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á "‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô" ‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
        const currentTransferNet = currentStats[u.name].transferOut - currentStats[u.name].transferIn;
        adjustedPrevStats[u.name] = {
            netBalance: previousStats[u.name].netBalance + currentTransferNet
        };
    });

    return { totalShared, splitAmount: totalShared / users.length, stats: currentStats, prevStats: previousStats, globalStats, adjustedPrevStats, budgetStatus, sortedCategories };

}, [expenses, users, budgetRules, categories, currentCycleInfo]);

// --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á (‡πÄ‡∏≠‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å‡∏•‡∏ö Surplus ‡∏≠‡∏≠‡∏Å) ---
const debtsByCycle = useMemo(() => {
    if (!formData.payer) return [];
    
    // 1. ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ "‡∏£‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const today = new Date();
    const { cycleName: realCurrentCycle } = getCycleRange(today);

    // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î Net ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const cycleGroups = {};
    expenses.forEach(exp => {
       const { cycleName } = getCycleRange(exp.date);
       if (!cycleGroups[cycleName]) cycleGroups[cycleName] = [];
       cycleGroups[cycleName].push(exp);
    });

    let allCycles = [];
    Object.entries(cycleGroups).forEach(([cycleName, cycleExps]) => {
        // ... (‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì stats, cost, paid ‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ) ...
        const stats = { cost: 0, paid: 0, transferIn: 0, transferOut: 0 };
        const payer = formData.payer; 
        const receiver = users.find(u => u.name !== payer)?.name;
        const catTotals = {};

        cycleExps.forEach(exp => {
            const val = parseFloat(exp.amount);
            // ... (Copy ‡πÑ‡∏™‡πâ‡πÉ‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
            if (exp.type === 'transfer') {
                if (exp.payer === payer) stats.transferOut += val;
                if (exp.payer === receiver) stats.transferIn += val;
            } else {
                if (exp.payer === payer) stats.paid += val;
                catTotals[exp.category] = (catTotals[exp.category] || 0) + val;
                const rule = budgetRules.find(r => r.category === exp.category);
                if (!rule) {
                    if (exp.type === 'shared') {
                            const split = exp.split !== undefined ? exp.split : 50;
                            if (users[0].name === payer) stats.cost += val * (split/100);
                            else stats.cost += val * ((100-split)/100);
                    } else if (exp.type === 'personal' && exp.payer === payer) stats.cost += val;
                        else if (exp.type === 'advance' && exp.payer !== payer) stats.cost += val / (users.length-1);
                }
            }
        });
        // ... (Budget Rule Logic ‡πÄ‡∏î‡∏¥‡∏°) ...
        budgetRules.forEach(rule => {
            if(catTotals[rule.category]) {
                const total = catTotals[rule.category];
                let ownerCost = total > rule.limit ? rule.limit : total;
                let excessCost = total > rule.limit ? total - rule.limit : 0;
                if(rule.owner === payer) stats.cost += ownerCost;
                if(rule.excessPayer === payer) stats.cost += excessCost;
            }
        });

        const net = (stats.paid + stats.transferOut) - (stats.cost + stats.transferIn);
        allCycles.push({ cycle: cycleName, net: net });
    });

    // 3. üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà: ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Surplus ‡∏°‡∏≤‡∏ï‡∏±‡∏î)
    const finalDebts = [];
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡∏µ‡πâ (net < 0) ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const pastDebtCycles = allCycles.filter(c => 
        c.net < -1 && // ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡∏µ‡πâ (‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏ö‡∏≤‡∏ó ‡∏Å‡∏±‡∏ô Error ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°)
        c.cycle !== realCurrentCycle // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    );

    pastDebtCycles.forEach(c => {
        // ‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡πÜ ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏´‡∏±‡∏Å surplus
        finalDebts.push({ cycle: c.cycle, amount: c.net }); 
    });

    return finalDebts;
}, [expenses, users, budgetRules, formData.payer]);

// --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô ---
      const installmentProgress = useMemo(() => {
         const progress = {}; 
         expenses.forEach(exp => {
            if (exp.type === 'transfer' && exp.relatedId) {
               progress[exp.relatedId] = (progress[exp.relatedId] || 0) + 1;
            }
         });
         return progress;
      }, [expenses]);
      
      const activeInstallments = useMemo(() => {
         if (!formData.payer) return [];
         return expenses.filter(exp => {
            if (exp.type !== 'installment') return false;
            if (exp.payer === formData.payer) return false; 
            if (new Date(exp.date) > new Date()) return false;
            const paidCount = installmentProgress[exp.id] || 0;
            return paidCount < (exp.months || 1);
         });
      }, [expenses, formData.payer, installmentProgress]);
      // ------------------------------------------

// ... (‡πÇ‡∏Ñ‡πâ‡∏î installmentProgress ‡πÄ‡∏î‡∏¥‡∏°) ...

      // üü¢ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô
      const installmentSummary = useMemo(() => {
         // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
         const installments = expenses.filter(e => e.type === 'installment');
         
         return installments.map(inst => {
            const paidCount = installmentProgress[inst.id] || 0; // ‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏µ‡πà‡∏á‡∏ß‡∏î
            const totalMonths = inst.months || 1;
            const amountPerMonth = inst.amount / totalMonths;
            const paidAmount = amountPerMonth * paidCount;
            const remainingAmount = inst.amount - paidAmount;
            const progressPercent = (paidCount / totalMonths) * 100;
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏à‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            const isCompleted = paidCount >= totalMonths;

            return { 
               ...inst, 
               paidCount, 
               totalMonths, 
               remainingAmount, 
               progressPercent, 
               isCompleted 
            };
         }).filter(item => !item.isCompleted); // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå
      }, [expenses, installmentProgress]);


      const [selectedCycles, setSelectedCycles] = useState([]);

      const toggleCycleSelection = (cycle, amount) => {
          let newSelection;
          if (selectedCycles.find(c => c.cycle === cycle)) {
              newSelection = selectedCycles.filter(c => c.cycle !== cycle);
          } else {
              newSelection = [...selectedCycles, { cycle, amount }];
          }
          setSelectedCycles(newSelection);
          
          const netTotal = newSelection.reduce((sum, item) => sum + item.amount, 0);
          const amountToPay = netTotal < 0 ? Math.abs(netTotal) : 0;

          setFormData(prev => ({ 
              ...prev, 
              amount: amountToPay > 0 ? amountToPay : '',
              note: newSelection.length > 0 ? `‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î: ${newSelection.map(c => c.cycle).join(', ')}` : ''
          }));
      };

const handleInputChange = (e) => {
        const { name, value } = e.target;
        
        if (name === 'title') {
           let suggestedCategory = null;
           const cleanTitle = value.trim().toLowerCase();

           if (cleanTitle) {
               // 1. ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ (‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
               const matchingExpenses = expenses.filter(exp => 
                   exp.title && exp.title.trim().toLowerCase() === cleanTitle
               );

               if (matchingExpenses.length > 0) {
                   // 2. ‡∏ô‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (Frequency Count)
                   // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: { '‡∏≠‡∏≤‡∏´‡∏≤‡∏£': 5, '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ': 1 }
                   const categoryCounts = matchingExpenses.reduce((acc, curr) => {
                       const cat = curr.category;
                       if (cat) {
                           acc[cat] = (acc[cat] || 0) + 1;
                       }
                       return acc;
                   }, {});

                   // 3. ‡∏´‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Most Frequent)
                   // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏¥‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
                   const sortedCategories = Object.keys(categoryCounts).sort(
                       (a, b) => categoryCounts[b] - categoryCounts[a]
                   );
                   
                   if (sortedCategories.length > 0) {
                       suggestedCategory = sortedCategories[0]; // ‚úÖ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î
                   }
               }
           }

           // 4. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏≤‡∏Ñ‡∏≥ (Autotag) ‡πÄ‡∏î‡∏¥‡∏°‡∏ä‡πà‡∏ß‡∏¢
           if (!suggestedCategory) {
               suggestedCategory = detectCategory(value);
           }

           // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï State
           if (suggestedCategory) {
               setFormData(prev => ({ ...prev, [name]: value, category: suggestedCategory }));
           } else {
               setFormData(prev => ({ ...prev, [name]: value }));
           }

        } else {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô field ‡∏≠‡∏∑‡πà‡∏ô
            setFormData(prev => ({ ...prev, [name]: value }));
        }
      };

const handleSubmit = (e) => {
        e.preventDefault();
        // Validation: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î
        if (!formData.title && formData.type !== 'transfer') return;
        
        let finalTitle = formData.title;
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        if (formData.type === 'transfer' && !finalTitle) finalTitle = '‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô / ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏ô';
        
        const amt = parseFloat(formData.amount);
        const now = new Date();
        const [year, month, day] = formData.date.split('-').map(Number);
        const dateWithTime = new Date(year, month - 1, day, now.getHours(), now.getMinutes(), now.getSeconds());
        const dateToSave = dateWithTime.toISOString();
        
        // üü¢ ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏Å‡∏£‡∏ì‡∏µ‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô
        if (formData.type === 'transfer' && formData.relatedInstallments && formData.relatedInstallments.length > 0) {
            formData.relatedInstallments.forEach(inst => {
               const installItem = expenses.find(x => x.id === inst.id);
               // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
               const payAmount = installItem.amount / installItem.months;
               // ‡∏ô‡∏±‡∏ö‡∏á‡∏ß‡∏î
               const currentTerm = (installmentProgress[inst.id] || 0) + 1;
               
               const repayTransaction = {
                  id: Date.now().toString() + Math.random().toString().slice(2,5), // ‡∏™‡∏∏‡πà‡∏° ID ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥
                  title: `‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô: ${installItem.title} (‡∏á‡∏ß‡∏î ${currentTerm}/${installItem.months})`,
                  amount: payAmount,
                  payer: formData.payer,
                  type: 'transfer',
                  date: dateToSave,
                  category: installItem.category,
                  relatedId: installItem.id, // ‡∏ú‡∏π‡∏Å ID ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô
                  note: formData.note
               };
               syncTransaction(repayTransaction);
               setExpenses(prev => [repayTransaction, ...prev]);
            });
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô)
            const totalInstallmentPay = formData.relatedInstallments.reduce((sum, item) => sum + (item.amount/item.months), 0);
            const remainingPay = amt - totalInstallmentPay;
            
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏®‡∏©‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô Transfer ‡∏õ‡∏Å‡∏ï‡∏¥‡∏≠‡∏µ‡∏Å‡∏Å‡πâ‡∏≠‡∏ô
            if (remainingPay > 1) { 
               const normalTransfer = {
                  ...formData, id: Date.now().toString(), amount: remainingPay, title: '‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô (‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)', relatedInstallments: []
               };
               syncTransaction(normalTransfer);
               setExpenses(prev => [normalTransfer, ...prev]);
            }
            
            addLog('‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô', `‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô ${formData.relatedInstallments.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, amt, formData.payer);

        } else {
            // üü¢ ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏° + ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏ï‡∏¥ / ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
            const newExpense = { 
                ...formData, 
                title: finalTitle, 
                id: editingId || Date.now().toString(), 
                amount: amt, 
                date: dateToSave,
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ú‡πà‡∏≠‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 1)
                months: formData.type === 'installment' ? parseInt(formData.months) : 1 
            };

            if (editingId) {
              setExpenses(prev => prev.map(exp => exp.id === editingId ? newExpense : exp));
              addLog('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', finalTitle, amt, formData.payer);
            } else {
              setExpenses(prev => [newExpense, ...prev]);
              addLog('‡πÄ‡∏û‡∏¥‡πà‡∏°', finalTitle, amt, formData.payer);
            }
            syncTransaction(newExpense); 
        }

        setIsModalOpen(false);
        resetForm();
      };

      const handleDelete = (id, title, amount, e) => {
        if (e) e.stopPropagation();
        if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
        setExpenses(prev => prev.filter(exp => exp.id !== id));
        addLog('‡∏•‡∏ö', title, amount, currentUser.name);
        syncDelete(id); 
      };

      const handleUserSubmit = (e) => {
        e.preventDefault();
        if (userFormData.id) {
            const oldName = users.find(u => u.id === userFormData.id)?.name;
            const newName = userFormData.name;
            const updatedUsers = users.map(u => u.id === userFormData.id ? userFormData : u);
            setUsers(updatedUsers);
            
            if (oldName !== newName) {
                setExpenses(prev => prev.map(exp => exp.payer === oldName ? { ...exp, payer: newName } : exp));
                setBudgetRules(prev => prev.map(rule => ({ ...rule, owner: rule.owner === oldName ? newName : rule.owner, excessPayer: rule.excessPayer === oldName ? newName : rule.excessPayer })));
                if (currentUser.name === oldName) setCurrentUser({ ...currentUser, name: newName });
                syncUsers(updatedUsers);
            } else {
                syncUsers(updatedUsers);
            }
        }
        setIsUserModalOpen(false);
      };

      const handleCategorySubmit = (e) => {
          e.preventDefault();
          const newCat = categoryFormData.trim();
          if (newCat && !categories.includes(newCat)) {
              setCategories(prev => [...prev, newCat]);
              syncCategory(newCat);
              setCategoryFormData('');
              setIsCategoryModalOpen(false);
          }
      };

      const handleDeleteCategory = (cat) => {
          if (confirm(`‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ${cat}?`)) {
              setCategories(prev => prev.filter(c => c !== cat));
              syncDeleteCategory(cat);
          }
      };

      const updateRules = (newRules) => {
          setBudgetRules(newRules);
          syncBudgetRules(newRules);
      };

const FilterBar = () => {
         const filters = [
            { id: 'all', label: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' },
            { id: 'shared', label: '‡∏´‡∏≤‡∏£‡∏Å‡∏±‡∏ô' },
            { id: 'personal', label: '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß' },
            { id: 'advance', label: '‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ' },
            { id: 'transfer', label: '‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô' },
            { id: 'installment', label: '‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞' }
         ];

         return (
             <div className="flex items-center gap-2 mb-4 overflow-x-auto no-scrollbar pb-2 pt-1">
                <span className="text-xs font-bold text-gray-400 whitespace-nowrap flex items-center gap-1">
                   <Filter className="w-3 h-3"/> ‡∏Å‡∏£‡∏≠‡∏á:
                </span>
                
                {filters.map(f => (
                    <button 
                        key={f.id}
                        onClick={() => setFilterMode(f.id)} 
                        className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap transition-colors flex items-center gap-1 ${filterMode === f.id ? 'bg-orange-100 text-orange-600 ring-1 ring-orange-200' : 'bg-white border text-gray-500 hover:bg-gray-50'}`}
                    >
                       {f.label}
                    </button>
                ))}

                <div className="relative border-l pl-2 ml-1">
                   <input type="date" value={filterDate} onChange={(e) => { setFilterDate(e.target.value); setFilterMode('date'); }} className={`pl-8 pr-2 py-1.5 rounded-lg text-xs font-bold border outline-none transition-colors ${filterMode === 'date' ? 'bg-orange-50 border-orange-200 text-orange-700' : 'bg-white border-gray-200 text-gray-500'}`}/>
                   <Calendar className={`w-3 h-3 absolute left-4 top-2 ${filterMode === 'date' ? 'text-orange-500' : 'text-gray-400'}`} />
                </div>
             </div>
         );
      };

      const expensesInCycleDisplay = useMemo(() => {
        const { startDate, endDate } = currentCycleInfo;
        return expenses.filter(exp => {
          const d = new Date(exp.date);
          return d >= startDate && d <= endDate;
        });
      }, [expenses, currentCycleInfo]);

// 1. ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö State ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
const [searchTerm, setSearchTerm] = useState('');

// 2. ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
const displayedExpenses = useMemo(() => {
  let data = [...expensesInCycleDisplay];
  
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  data.sort((a, b) => new Date(b.date) - new Date(a.date));

  // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Search Logic) ---
  if (searchTerm) {
      const lowerTerm = searchTerm.trim().toLowerCase();
      data = data.filter(exp => 
          (exp.title && exp.title.toLowerCase().includes(lowerTerm)) || 
          (exp.note && exp.note.toLowerCase().includes(lowerTerm))
      );
  }
  // -----------------------------------------------------

  // Logic ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° (Date / Type)
  if (filterMode === 'date') {
     const target = new Date(filterDate).toDateString();
     data = data.filter(exp => new Date(exp.date).toDateString() === target);
  } else if (filterMode !== 'all') { // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏Å‡πâ FilterBar ‡πÄ‡∏õ‡πá‡∏ô Type ‡πÅ‡∏•‡πâ‡∏ß
     data = data.filter(exp => exp.type === filterMode);
  } else if (filterMode === 'last3') { // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ logic ‡πÄ‡∏Å‡πà‡∏≤
     const threeDaysAgo = new Date();
     threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
     threeDaysAgo.setHours(0, 0, 0, 0);
     data = data.filter(exp => new Date(exp.date) >= threeDaysAgo);
  }

  return data;
}, [expensesInCycleDisplay, filterMode, filterDate, searchTerm]); // ‚úÖ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà searchTerm ‡πÉ‡∏ô dependency

      const displayedLogs = useMemo(() => {
        let data = [...logs];
        data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        if (filterMode === 'last3') {
           const threeDaysAgo = new Date();
           threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
           threeDaysAgo.setHours(0, 0, 0, 0);
           data = data.filter(l => new Date(l.timestamp) >= threeDaysAgo);
        } else if (filterMode === 'date') {
           const target = new Date(filterDate).toDateString();
           data = data.filter(l => new Date(l.timestamp).toDateString() === target);
        }
        return data;
      }, [logs, filterMode, filterDate]);

      if (isLoading) {
          return <div className="h-screen flex items-center justify-center text-orange-500 font-bold animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>;
      }

      if (isUnauthorized) {
         return (
            <div className="h-screen flex flex-col items-center justify-center bg-gray-100 p-4 font-kanit">
               <div className="bg-white p-8 rounded-3xl shadow-xl text-center max-w-sm w-full">
                  <div className="w-20 h-20 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                     <X className="w-10 h-10" />
                  </div>
                  <h1 className="text-xl font-bold text-gray-800 mb-2">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</h1>
                  <p className="text-gray-500 text-sm mb-6">
                     ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì <br/>
                     <span className="font-bold text-gray-800">{myEmail}</span><br/>
                     ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin
                  </p>
                  <button onClick={() => window.location.reload()} className="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-300 transition-colors">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
               </div>
            </div>
         );
      }

      return (
        <div className="min-h-screen bg-gray-100 font-kanit pb-24">
          <div className="bg-gradient-to-r from-[#FF8C42] to-[#F6C700] text-white px-6 pt-8 pb-24 rounded-b-[2rem] shadow-lg relative z-0">
            <div className="flex justify-between items-start max-w-2xl mx-auto mb-2">
              <div>
                <h1 className="text-2xl font-bold flex items-center gap-2">
                  <Wallet className="w-8 h-8" /> ShareJai
                </h1>
                <p className="text-orange-50 text-sm mt-1 opacity-90">‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ‡∏á‡πà‡∏≤‡∏¢‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>
              </div>
              <div className="flex flex-col items-end gap-2">
                 <div className="flex items-center gap-2 bg-white/20 p-1 pl-3 pr-1 rounded-full backdrop-blur-sm">
                    <span className="text-[10px] font-bold text-white flex items-center gap-1"><Eye className="w-3 h-3"/> ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á:</span>
                    <select 
                       disabled={currentUser?.role !== 'Admin'} 
                       value={currentUser?.id || ''}
                       onChange={(e) => {
                           const selected = users.find(u => u.id === parseInt(e.target.value));
                           setCurrentUser(selected);
                           setFormData(prev => ({ ...prev, payer: selected.name }));
                       }}
                       className={`bg-white text-orange-600 text-xs font-bold py-1 px-2 rounded-full outline-none ${currentUser?.role === 'Admin' ? 'cursor-pointer' : 'cursor-not-allowed opacity-80'}`}
                    >
                       {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                    </select>
                 </div>
                 
                 <div className="flex items-center bg-white/10 rounded-lg backdrop-blur-sm">
                    <button onClick={() => changeCycle(-1)} className="p-2 hover:bg-white/10 rounded-l-lg transition-colors"><ChevronLeft className="w-4 h-4"/></button>
                    <div className="px-2 text-center">
                        <span className="text-[10px] font-medium block text-orange-50">‡∏£‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏ï‡∏±‡∏î‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5)</span>
                       <span className="text-xs font-bold block min-w-[120px]">{currentCycleInfo.cycleName}</span>
                    </div>
                    <button onClick={() => changeCycle(1)} className="p-2 hover:bg-white/10 rounded-r-lg transition-colors"><ChevronRight className="w-4 h-4"/></button>
                 </div>
              </div>
            </div>
          </div>

          <div className="max-w-2xl mx-auto px-4 -mt-20 relative z-10">
            
            <div className="bg-white rounded-3xl p-6 shadow-xl mb-6">
              <div className="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                 <h2 className="text-gray-800 font-bold text-lg flex items-center gap-2">
                   <Calculator className="w-5 h-5 text-orange-500" /> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
                 </h2>
                 <button onClick={() => setShowBudgetConfig(!showBudgetConfig)} className="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded-md flex items-center gap-1 hover:bg-orange-100 font-medium">
                   <Settings className="w-3 h-3" /> ‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö
                 </button>
              </div>

{/* Previous Cycle Balance (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ adjustedPrevStats ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏î‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô) */}
              {users.length >= 2 && Math.abs(calculation.adjustedPrevStats[users[0].name]?.netBalance) > 1 && (
                 <div className="bg-gray-100 border border-gray-200 rounded-2xl p-3 mb-4 flex items-center justify-between">
                    <div className="flex items-center gap-2">
                       <div className="bg-gray-200 p-2 rounded-full text-gray-500">
                          <History className="w-4 h-4" />
                       </div>
                       <div>
                          <p className="text-[10px] font-bold text-gray-500">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)</p>
                          <p className="text-xs font-bold text-gray-700 flex items-center gap-1">
                             {calculation.adjustedPrevStats[users[1].name].netBalance < 0 ? (
                                <>{users[1].name} <ArrowRight className="w-3 h-3"/> {users[0].name}</>
                             ) : (
                                <>{users[0].name} <ArrowRight className="w-3 h-3"/> {users[1].name}</>
                             )}
                          </p>
                       </div>
                    </div>
                    <span className="text-lg font-bold text-gray-800">
                       {formatMoney(Math.abs(calculation.adjustedPrevStats[users[0].name].netBalance))}
                    </span>
                 </div>
              )}

{/* === ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Collapsible Budget) === */}
              {calculation.budgetStatus.length > 0 && (
                 <div className="mb-4 border border-gray-100 rounded-2xl overflow-hidden transition-all duration-300">
                    {/* Header: ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢ */}
                    <div 
                       onClick={() => setIsBudgetExpanded(!isBudgetExpanded)}
                       className="p-3 flex justify-between items-center cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors"
                    >
                       <span className="text-xs font-bold text-gray-700 flex items-center gap-2">
                          <BarChart3 className="w-4 h-4 text-orange-500" />
                          ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
                          {/* ‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏á‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏à‡∏∏‡∏î‡πÅ‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô */}
                          {!isBudgetExpanded && calculation.budgetStatus.some(b => b.isExceeded) && (
                             <span className="flex h-2 w-2 relative">
                                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                <span className="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                             </span>
                          )}
                       </span>
                       <div className="flex items-center gap-2">
                          <span className="text-[10px] text-gray-400 font-normal">{calculation.budgetStatus.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                          {isBudgetExpanded ? <ChevronLeft className="w-4 h-4 text-gray-400 -rotate-90 transition-transform" /> : <ChevronLeft className="w-4 h-4 text-gray-400 rotate-180 transition-transform" />}
                       </div>
                    </div>

                    {/* Content: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì */}
                    {isBudgetExpanded && (
                       <div className="p-3 bg-white space-y-3 animate-in slide-in-from-top-2">
                           {calculation.budgetStatus.map((status) => (
                               <div key={status.id} className={`p-3 rounded-xl border ${status.isExceeded ? 'bg-red-50 border-red-100' : 'bg-green-50 border-green-100'}`}>
                                  <div className="flex justify-between items-center mb-2">
                                     <span className="text-xs font-bold text-gray-700 flex items-center gap-1">
                                        <AlertTriangle className={`w-3 h-3 ${status.isExceeded ? 'text-red-500' : 'text-green-500'}`} />
                                        {status.category} ({formatMoney(status.limit)})
                                     </span>
                                     <span className={`text-xs font-bold ${status.isExceeded ? 'text-red-600' : 'text-green-600'}`}>
                                        ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ {formatMoney(status.total)}
                                     </span>
                                  </div>
                                  <div className="w-full bg-gray-200 rounded-full h-1.5 mb-2">
                                     <div className={`h-1.5 rounded-full ${status.isExceeded ? 'bg-red-500' : 'bg-green-500'}`} style={{ width: `${Math.min((status.total / (status.limit || 1)) * 100, 100)}%` }}></div>
                                  </div>
                                  {status.isExceeded && (
                                     <div className="mt-2 text-[10px] bg-white/50 text-red-700 p-1.5 rounded-lg text-center font-bold border border-red-200/50">
                                        {status.excessPayer} ‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ {formatMoney(status.excessPayerPaid)} 
                                        {status.excessPayerNet > 0 
                                           ? ` ‚Üí ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏° ${formatMoney(status.excessPayerNet)}`
                                           : ` ‚Üí ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô ${formatMoney(Math.abs(status.excessPayerNet))}`
                                        }
                                     </div>
                                  )}
                               </div>
                           ))}
                       </div>
                    )}
                 </div>
              )}
              <div className="mb-6 mt-4">
                  <div className="bg-gradient-to-r from-orange-50 to-orange-100/50 p-4 rounded-2xl text-center border border-orange-100 shadow-sm relative overflow-hidden">
                     <div className="absolute top-0 right-0 -mt-2 -mr-2 w-16 h-16 bg-orange-200 rounded-full opacity-20 blur-xl"></div>
                     <div className="absolute bottom-0 left-0 -mb-2 -ml-2 w-16 h-16 bg-yellow-200 rounded-full opacity-20 blur-xl"></div>
                     
                     <p className="text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider relative z-10">‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏£‡∏ß‡∏°</p>
                     <p className="text-3xl font-extrabold text-orange-600 tracking-tight relative z-10">
                         {formatMoney(calculation.totalShared)}
                     </p>
                  </div>
               </div>

{/* Settlement Box (‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏î‡∏≥) */}
{users.length >= 2 && calculation.stats[users[0].name] && calculation.stats[users[1].name] && (
<div className="bg-gray-800 text-white rounded-2xl p-5 flex flex-col sm:flex-row items-center justify-between shadow-lg gap-3 sm:gap-0">
    <div className="flex flex-col items-center sm:items-start w-full sm:w-auto">
        <span className="text-xs text-gray-400 mb-1">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ)</span>
        
        {/* ‚úÖ ‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏ä‡πâ .netBalanceNoTransfer ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç */}
        {Math.abs(calculation.stats[users[0].name].netBalanceNoTransfer) < 1 ? (
            <span className="font-bold text-green-400 mt-1 flex items-center gap-1"><CheckCircle2 className="w-4 h-4"/> ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
        ) : (
            <div className="mt-1 text-base sm:text-lg font-bold text-yellow-400 flex flex-wrap justify-center items-center gap-2">
                {/* ‚úÖ ‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡πÉ‡∏ä‡πâ .netBalanceNoTransfer ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏ï‡∏¥‡∏î‡πÉ‡∏Ñ‡∏£ */}
                {calculation.stats[users[1].name].netBalanceNoTransfer < 0 ? (
                    <>{users[1].name} <ArrowRight className="w-4 h-4 sm:w-5 sm:h-5"/> ‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô {users[0].name}</>
                ) : (
                    <>{users[0].name} <ArrowRight className="w-4 h-4 sm:w-5 sm:h-5"/> ‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô {users[1].name}</>
                )}
            </div>
        )}
    </div>
    <div className="text-center sm:text-right w-full sm:w-auto border-t sm:border-t-0 border-gray-700 pt-3 sm:pt-0 mt-2 sm:mt-0">
        <span className="text-2xl sm:text-3xl font-bold tracking-tighter block">
            {/* ‚úÖ ‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 3: ‡πÉ‡∏ä‡πâ .netBalanceNoTransfer ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç */}
            {Math.abs(calculation.stats[users[0].name].netBalanceNoTransfer) < 1 ? '‡∏ø0' : formatMoney(Math.abs(calculation.stats[users[0].name].netBalanceNoTransfer))}
        </span>
    </div>
</div>
)}

{/* === ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ (Installment Tracking) ‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢‡πÑ‡∏î‡πâ === */}
            {installmentSummary.length > 0 && (
               <div className="mt-6 bg-white border border-gray-200 rounded-3xl overflow-hidden shadow-sm transition-all duration-300">
                  {/* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î (Header) ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢‡πÑ‡∏î‡πâ */}
                  <div 
                     onClick={() => setIsInstallmentExpanded(!isInstallmentExpanded)}
                     className="p-5 flex justify-between items-center cursor-pointer bg-white hover:bg-gray-50 transition-colors"
                  >
                     <h3 className="text-gray-800 font-bold text-sm flex items-center gap-2">
                        <Calendar className="w-5 h-5 text-blue-500" /> 
                        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á 
                        <span className="bg-blue-100 text-blue-600 text-[10px] px-2 py-0.5 rounded-full">
                           {installmentSummary.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </span>
                     </h3>
                     {/* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏´‡∏°‡∏∏‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */}
                     <button className="text-gray-400">
                        {isInstallmentExpanded ? <ChevronLeft className="w-5 h-5 -rotate-90 transition-transform" /> : <ChevronLeft className="w-5 h-5 rotate-180 transition-transform" />}
                     </button>
                  </div>
                  
                  {/* ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Content) ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà */}
                  {isInstallmentExpanded && (
                     <div className="px-5 pb-5 space-y-4 animate-in slide-in-from-top-2 duration-300">
                        {installmentSummary.map(inst => (
                           <div key={inst.id} className="bg-gray-50 rounded-xl p-3 border border-gray-100">
                              <div className="flex justify-between items-start mb-2">
                                 <div>
                                    <p className="font-bold text-gray-700 text-sm">{inst.title}</p>
                                    <p className="text-[10px] text-gray-400 flex items-center gap-1">
                                       <UserCircle className="w-3 h-3"/> ‡∏Ñ‡∏ô‡∏£‡∏π‡∏î: {inst.payer}
                                    </p>
                                 </div>
                                 <div className="text-right">
                                    <p className="font-bold text-blue-600 text-sm">{formatMoney(inst.remainingAmount)}</p>
                                    <p className="text-[10px] text-gray-400">‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                                 </div>
                              </div>

                              {/* Progress Bar */}
                              <div className="relative pt-1">
                                 <div className="flex mb-1 items-center justify-between">
                                    <div className="text-[10px] font-semibold text-blue-600 inline-block px-2 py-0.5 rounded-full bg-blue-100">
                                       ‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà {inst.paidCount} / {inst.totalMonths}
                                    </div>
                                    <div className="text-right">
                                       <span className="text-[10px] font-semibold inline-block text-blue-600">
                                          {Math.round(inst.progressPercent)}%
                                       </span>
                                    </div>
                                 </div>
                                 <div className="overflow-hidden h-2 mb-1 text-xs flex rounded bg-blue-200">
                                    <div style={{ width: `${inst.progressPercent}%` }} className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 transition-all duration-500"></div>
                                 </div>
                              </div>
                              
                              <div className="flex justify-between text-[10px] text-gray-400 mt-1">
                                 <span>‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°: {formatMoney(inst.amount)}</span>
                                 <span>‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞: {formatMoney(inst.amount / inst.totalMonths)}</span>
                              </div>
                           </div>
                        ))}
                     </div>
                  )}
               </div>
            )}

              <div className="mt-8 pt-4 border-t border-gray-100">
                 <h3 className="text-sm font-bold text-gray-600 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á (‡∏ï‡∏≤‡∏°‡∏á‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á)</h3>
<div className="grid grid-cols-2 gap-4">
  {users.map((u, idx) => {
      const s = calculation.stats[u.name] || { paid:0, cost:0, personal:0, netBalance:0, installmentPayment: 0, advanceDebt: 0 };
      const isPositive = s.netBalance > 0;
      const displayCost = s.cost + (s.installmentPayment || 0);
      const displayPaid = s.paid + (s.installmentPayment || 0);

      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢ (Creditor) 
      // (‡∏´‡∏≤ user ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô")
      const creditor = users.find(user => user.name !== u.name);
      const creditorName = creditor ? creditor.name : '‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô';

      return (
          <div key={u.id} className={`rounded-xl p-3 border relative overflow-hidden ${currentUser?.name === u.name ? 'bg-yellow-50/50 border-yellow-200' : 'bg-white border-gray-100'}`}>
            {Math.abs(s.netBalance) > 1 && (
                <div className={`absolute top-0 right-0 text-white text-[10px] px-2 py-0.5 rounded-bl-lg font-bold ${isPositive ? 'bg-green-500' : 'bg-red-500'}`}>
                    {isPositive ? `‡∏£‡∏±‡∏ö ${formatMoney(s.netBalance)}` : `‡∏à‡πà‡∏≤‡∏¢ ${formatMoney(Math.abs(s.netBalance))}`}
                </div>
            )}
            <div className="flex items-center gap-2 mb-3 mt-1">
                <div className={`w-2 h-2 rounded-full ${idx === 0 ? 'bg-orange-500' : 'bg-blue-500'}`}></div>
                <span className="font-bold text-gray-700 text-sm">{u.name}</span>
            </div>

            <div className="space-y-1.5 text-xs text-gray-500">
                
                {/* 1. ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß */}
                <div className="flex justify-between">
                   <span>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</span>
                   <span>{formatMoney(s.personal)}</span>
                </div>

                {/* 2. ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ (Dynamic Name) */}
                {s.advanceDebt > 0 && (
                   <div className="flex justify-between">
                      {/* ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ creditorName ‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô */}
                      <span>{creditorName}‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Å‡πà‡∏≠‡∏ô</span>
                      <span>{formatMoney(s.advanceDebt)}</span>
                   </div>
                )}

                {/* 3. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ */}
                <div className="flex justify-between">
                   <span>‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</span>
                   <span>{formatMoney(s.cost - s.personal - (s.advanceDebt || 0))}</span>
                </div>

                {/* 4. ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ */}
                {(s.installmentPayment > 0) && (
                   <div className="flex justify-between">
                      <span>‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                      <span>{formatMoney(s.installmentPayment)}</span>
                   </div>
                )}

                <div className={`border-t pt-1 mt-1 flex justify-between font-bold ${idx === 0 ? 'border-orange-100 text-orange-700' : 'border-blue-100 text-blue-700'}`}>
                   <span>‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</span><span>{formatMoney(displayCost)}</span>
                </div>
                
                <div className="flex justify-between text-gray-400"><span>‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</span><span>{formatMoney(displayPaid)}</span></div>
            </div>
          </div>
      );
  })}
</div>
              </div>
            </div>

           {/* === CATEGORY SUMMARY CARD (Collapsible) === */}
            <div className="bg-white rounded-3xl border border-gray-200 shadow-sm mb-6 overflow-hidden transition-all duration-300">
               {/* Header: ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏î‡πÑ‡∏î‡πâ */}
               <div 
                  onClick={() => setIsCategoryExpanded(!isCategoryExpanded)}
                  className="p-5 flex justify-between items-center cursor-pointer bg-white hover:bg-gray-50 transition-colors"
               >
                  <div className="flex items-center gap-2">
                     <PieChart className="w-5 h-5 text-orange-500"/>
                     <h2 className="text-gray-800 font-bold text-sm">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h2>
                     {/* ‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô‡πÜ */}
                     {!isCategoryExpanded && (
                        <span className="bg-orange-100 text-orange-600 text-[10px] px-2 py-0.5 rounded-full font-bold">
                           ‡∏£‡∏ß‡∏° {formatMoney(calculation.totalShared)}
                        </span>
                     )}
                  </div>
                  <button className="text-gray-400">
                     {isCategoryExpanded ? <ChevronLeft className="w-5 h-5 -rotate-90 transition-transform" /> : <ChevronLeft className="w-5 h-5 rotate-180 transition-transform" />}
                  </button>
               </div>

               {/* Content: ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î */}
               {isCategoryExpanded && (
                  <div className="px-5 pb-5 animate-in slide-in-from-top-2">
                     {/* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î ‡∏£‡∏ß‡∏°/‡πÅ‡∏¢‡∏Å (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô) */}
                     <div className="flex justify-end mb-4">
                        <div className="flex bg-gray-100 p-1 rounded-lg">
                           <button 
                              onClick={(e) => { e.stopPropagation(); setCategoryViewMode('total'); }} 
                              className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${categoryViewMode === 'total' ? 'bg-white text-orange-600 shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}
                           >
                              ‡∏£‡∏ß‡∏°
                           </button>
                           <button 
                              onClick={(e) => { e.stopPropagation(); setCategoryViewMode('separate'); }} 
                              className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${categoryViewMode === 'separate' ? 'bg-white text-orange-600 shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}
                           >
                              ‡πÅ‡∏¢‡∏Å
                           </button>
                        </div>
                     </div>
                     
                     <div className="space-y-5">
                        {calculation.sortedCategories.length === 0 ? (
                           <p className="text-center text-gray-300 text-sm py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                        ) : (
                           calculation.sortedCategories.map(([cat, data]) => (
                              <div key={cat} className="mb-2">
                                 <div className="flex justify-between items-end mb-2">
                                    <span className="text-sm font-bold text-gray-700">{cat}</span>
                                    <span className="text-base font-extrabold text-gray-900 tracking-tight">{formatMoney(data.total)}</span>
                                 </div>
                                 
                                 <div className="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden flex">
                                    {categoryViewMode === 'total' ? (
                                         <div className="h-full bg-orange-500" style={{ width: `${(data.total / calculation.sortedCategories[0][1].total) * 100}%` }}></div>
                                    ) : (
                                       users.map((u, idx) => {
                                          const userShare = data.users[u.name] || 0;
                                          const pct = (userShare / data.total) * 100;
                                          if (pct === 0) return null;
                                          return <div key={u.id} className={`h-full ${idx === 0 ? 'bg-orange-500' : 'bg-blue-500'}`} style={{ width: `${pct}%` }}></div>;
                                      })
                                    )}
                                 </div>
                                 
                                 {categoryViewMode === 'separate' && (
                                    <div className="flex justify-end gap-3 mt-1.5 text-[10px] text-gray-400 font-medium">
                                       {users.map((u, idx) => {
                                          const val = data.users[u.name] || 0;
                                          if (val === 0) return null;
                                          return (
                                             <span key={u.id} className="flex items-center gap-1">
                                                <div className={`w-2 h-2 rounded-full ${idx === 0 ? 'bg-orange-500' : 'bg-blue-500'}`}></div>
                                                {u.name} {formatMoney(val)}
                                             </span>
                                          );
                                       })}
                                    </div>
                                 )}
                              </div>
                           ))
                        )}
                     </div>
                  </div>
               )}
            </div>

            <div className="flex gap-2 overflow-x-auto pb-2 mb-4 no-scrollbar">
               {[
                 { id: 'expenses', label: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', icon: Calculator },
                 { id: 'logs', label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥', icon: History },
                 { id: 'users', label: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', icon: Users },
                 { id: 'categories', label: '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', icon: Tag },
               ].map(tab => {
                  const TabIcon = tab.icon;
                  return (
                    <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        className={`px-5 py-2.5 rounded-full text-xs font-bold transition-all whitespace-nowrap flex items-center gap-2 ${activeTab === tab.id ? 'bg-orange-500 text-white shadow-md transform scale-105' : 'bg-white text-gray-500 border border-gray-200 hover:bg-gray-50'}`}
                    >
                        <TabIcon className="w-3 h-3"/> {tab.label}
                    </button>
                  )
               })}
            </div>

            {activeTab === 'expenses' && (
                <div className="space-y-3 mb-32">
                <div className="relative mb-2">
           <input 
               type="text" 
               placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..." 
               value={searchTerm}
               onChange={(e) => setSearchTerm(e.target.value)}
               className="w-full pl-10 pr-10 py-2.5 rounded-xl border border-gray-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 shadow-sm transition-all"
           />
           <Search className="w-4 h-4 absolute left-3.5 top-3 text-gray-400" />
           
           {/* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏Å‡∏ö‡∏≤‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß) */}
           {searchTerm && (
               <button 
                   onClick={() => setSearchTerm('')}
                   className="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600 bg-gray-100 rounded-full p-0.5"
               >
                   <X className="w-3 h-3" />
               </button>
           )}
       </div>
                   <FilterBar />
                   {displayedExpenses.length === 0 ? (
                      <div className="text-center py-10 text-gray-400 bg-white rounded-2xl border border-dashed border-gray-300"><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</p></div>
                   ) : (
                        displayedExpenses.map((exp) => (
                        <div key={exp.id} className={`p-4 rounded-2xl shadow-sm border flex justify-between items-center group relative overflow-hidden bg-white border-gray-100 hover:shadow-md transition-shadow`}>
                          <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${users[0] && exp.payer === users[0].name ? 'bg-orange-400' : 'bg-blue-400'}`}></div>
                          <div className="flex-1 ml-4">
                            <div className="flex items-center gap-2 mb-1">
                              <h3 className="font-bold text-gray-800 text-sm">{exp.title}</h3>
                              <span className="px-2 py-0.5 bg-gray-100 text-gray-500 text-[10px] rounded-full">{exp.category}</span>
                              {exp.type === 'shared' && <span className="px-2 py-0.5 bg-orange-100 text-orange-600 text-[10px] rounded-full font-bold">‡∏´‡∏≤‡∏£‡∏Å‡∏±‡∏ô</span>}
                              {exp.type === 'personal' && <span className="px-2 py-0.5 bg-purple-100 text-purple-600 text-[10px] rounded-full font-bold">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</span>}
                              {exp.type === 'installment' && <span className="px-2 py-0.5 bg-blue-100 text-blue-600 text-[10px] rounded-full font-bold">‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</span>}
                              {exp.type === 'transfer' && <span className="px-2 py-0.5 bg-green-100 text-green-600 text-[10px] rounded-full">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>}
                              {exp.type === 'advance' && <span className="px-2 py-0.5 bg-red-100 text-red-600 text-[10px] rounded-full">‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ</span>}
                              {exp.attachments && exp.attachments.length > 0 && <span className="px-2 py-0.5 bg-blue-100 text-blue-600 text-[10px] rounded-full flex items-center gap-1"><Paperclip className="w-3 h-3"/> {exp.attachments.length}</span>}
                            </div>
                            <div className="flex items-center gap-2 text-xs text-gray-400">
                               <span className="flex items-center gap-1"><Calendar className="w-3 h-3"/> {new Date(exp.date).toLocaleDateString('th-TH')}</span>
                              <span>‚Ä¢</span>
                              <span className="flex items-center gap-1"><UserCircle className="w-3 h-3"/> ‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏î‡∏¢ {exp.payer}</span>
                            </div>
                            {exp.note && <p className="text-xs text-gray-400 mt-1 italic pl-2 border-l-2 border-gray-200">"{exp.note}"</p>}
                          </div>
                          <div className="text-right pl-3">
                             <p className={`font-bold text-lg ${exp.type === 'transfer' ? 'text-green-600' : 'text-gray-800'}`}>{formatMoney(exp.amount)}</p>
                            <div className="flex gap-2 justify-end mt-2 opacity-30 group-hover:opacity-100 transition-opacity">
                              {exp.attachments && exp.attachments.length > 0 && (
                                 <button onClick={() => setViewingAttachments(exp)} className="p-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100"><Paperclip className="w-3 h-3"/></button>
                              )}
                              <button onClick={() => { setFormData({...exp, date: exp.date.split('T')[0]}); setEditingId(exp.id); setIsModalOpen(true); }} className="p-1.5 bg-yellow-100 text-yellow-600 rounded-lg hover:bg-yellow-200"><Edit2 className="w-3 h-3"/></button>
                              <button onClick={(e) => handleDelete(exp.id, exp.title, exp.amount, e)} className="p-1.5 bg-red-100 text-red-600 rounded-lg hover:bg-red-200"><Trash2 className="w-3 h-3"/></button>
                            </div>
                          </div>
                        </div>
                      ))
                   )}
                </div>
            )}

            {activeTab === 'users' && (
                <div className="bg-white rounded-2xl p-6 shadow-sm mb-32">
                  <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4"><Users className="w-5 h-5"/> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                  <div className="space-y-3">
                     {users.map(u => (
                        <div key={u.id} className="flex justify-between items-center p-4 border border-gray-100 rounded-xl hover:bg-gray-50">
                           <div className="flex items-center gap-3">
                              <div className="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-500 font-bold text-lg">{u.name.charAt(0)}</div>
                              <div><p className="font-bold text-gray-800">{u.name}</p><p className="text-xs text-gray-400 flex items-center gap-1"><Mail className="w-3 h-3"/> {u.email}</p></div>
                           </div>
                           <button onClick={() => { setUserFormData(u); setIsUserModalOpen(true); }} className="p-2 text-gray-400 hover:text-orange-500 bg-gray-50 hover:bg-orange-50 rounded-full"><Edit2 className="w-4 h-4"/></button>
                        </div>
                     ))}
                  </div>
               </div>
            )}
            
            {activeTab === 'categories' && (
               <div className="bg-white rounded-2xl p-6 shadow-sm mb-32">
                  <div className="flex justify-between items-center mb-6">
                     <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2"><Tag className="w-5 h-5"/> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h2>
                     <button onClick={() => setIsCategoryModalOpen(true)} className="bg-orange-100 text-orange-600 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-orange-200"><Plus className="w-3 h-3"/> ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                   </div>
                  <div className="grid grid-cols-2 gap-3">
                     {categories.map(cat => (
                        <div key={cat} className="flex justify-between items-center p-3 border border-gray-100 rounded-xl bg-gray-50">
                           <span className="text-sm font-medium text-gray-700">{cat}</span>
                           <button onClick={() => handleDeleteCategory(cat)} className="text-gray-300 hover:text-red-500"><X className="w-4 h-4"/></button>
                        </div>
                     ))}
                  </div>
               </div>
            )}
            
            {activeTab === 'logs' && (
               <div className="space-y-3 mb-32">
                  <FilterBar />
                  {displayedLogs.length === 0 ? <div className="text-center py-10 text-gray-400 bg-white rounded-2xl">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</div> : 
                     displayedLogs.map(log => (
                        <div key={log.id} className="bg-white p-4 rounded-xl border-l-4 border-orange-400 shadow-sm">
                           <div className="flex justify-between items-start mb-1">
                              <span className={`text-xs font-bold px-2 py-0.5 rounded ${log.action === '‡πÄ‡∏û‡∏¥‡πà‡∏°' ? 'bg-green-100 text-green-700' : log.action === '‡∏•‡∏ö' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}`}>{log.action}</span>
                              <span className="text-[10px] text-gray-400">{new Date(log.timestamp).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' })} {new Date(log.timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}</span>
                           </div>
                           <p className="text-sm text-gray-800 font-medium mt-1">{log.detail}</p>
                           <p className="text-xs text-gray-400 mt-2 flex items-center gap-1 border-t pt-2"><UserCircle className="w-3 h-3"/> ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢: {log.actor}</p>
                        </div>
                     ))
                  }
               </div>
            )}

            {activeTab === 'expenses' && (
              <button onClick={() => { resetForm(); setIsModalOpen(true); }} className="fixed bottom-8 right-6 bg-gradient-to-r from-orange-500 to-red-500 text-white p-4 rounded-full shadow-xl hover:scale-110 transition-transform z-30"><Plus className="w-8 h-8" /></button>
            )}

            {viewingAttachments && (
               <div className="fixed inset-0 bg-black/90 z-50 flex flex-col justify-center p-4 backdrop-blur-sm animate-in fade-in">
                  <div className="flex justify-between items-center text-white mb-4">
                     <h2 className="text-lg font-bold">‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö ({viewingAttachments.attachments.length})</h2>
                     <button onClick={() => setViewingAttachments(null)} className="p-2 bg-white/20 rounded-full hover:bg-white/30"><X className="w-6 h-6"/></button>
                  </div>
                  <div className="flex-1 overflow-y-auto space-y-4">
                     {viewingAttachments.attachments.map((att, idx) => (
                        <div key={idx} className="bg-white rounded-lg overflow-hidden">
                           {att.type.startsWith('image/') ? (
                              <img src={att.data || att.url} alt="attachment" className="w-full h-auto object-contain" />
                           ) : (
                              <div className="p-10 flex flex-col items-center justify-center text-gray-500 gap-2">
                                 <FileText className="w-12 h-12 text-red-400"/>
                                 <span className="text-sm font-bold">{att.name}</span>
                                 <a href={att.data || att.url} target="_blank" download={att.name} className="text-xs bg-gray-100 px-3 py-1 rounded-full mt-2 hover:bg-gray-200">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π / ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</a>
                              </div>
                           )}
                           <div className="p-2 text-xs text-gray-500 bg-gray-50 text-center border-t">{att.name}</div>
                        </div>
                     ))}
                  </div>
               </div>
            )}

            {isModalOpen && (
              <div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
                <div className="bg-white rounded-t-3xl sm:rounded-2xl w-full max-w-md p-6 shadow-2xl animate-in slide-in-from-bottom-10 sm:slide-in-from-bottom-0 sm:zoom-in-95 max-h-[90vh] overflow-y-auto">
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-bold text-gray-800">{editingId ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà'}</h2>
                    <button onClick={() => setIsModalOpen(false)} className="bg-gray-100 p-2 rounded-full text-gray-500 hover:bg-gray-200"><X className="w-5 h-5" /></button>
                  </div>
                  <form onSubmit={handleSubmit} className="space-y-4">
<div className="bg-orange-50 p-1.5 rounded-xl flex gap-1 overflow-x-auto no-scrollbar mb-4">
   {['shared', 'personal', 'advance', 'installment', 'transfer'].map(t => (
      <button 
        key={t} 
        type="button" 
        onClick={() => {
            setFormData(prev => ({...prev, type: t}));
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô
            if (t !== 'transfer') {
               setSelectedCycles([]); 
               setFormData(prev => ({...prev, relatedInstallments: []}));
            }
        }} 
        className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${formData.type === t ? 'bg-white text-orange-600 shadow-sm' : 'text-gray-500 hover:bg-white/50'}`}>
        {t === 'shared' ? '‡∏´‡∏≤‡∏£‡∏Å‡∏±‡∏ô' : t === 'personal' ? '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß' : t === 'advance' ? '‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ' : t === 'installment' ? '‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞' : '‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô'}
       </button>
   ))}
</div>

{/* ‡∏™‡πà‡∏ß‡∏ô Slider ‡∏´‡∏≤‡∏£‡∏Å‡∏±‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏≤‡∏£‡∏Å‡∏±‡∏ô) */}
{formData.type === 'shared' && users.length >= 2 && (
    <div className="bg-gray-50 p-3 rounded-xl border border-gray-200 mb-4">
      <div className="flex justify-between mb-2 text-xs font-bold text-gray-600">
         <span>{users[0].name} ({formData.split}%)</span>
         <span>{users[1].name} ({100 - formData.split}%)</span>
      </div>
      <input 
        type="range" min="0" max="100" step="5" 
        value={formData.split} 
        onChange={(e) => setFormData(prev => ({...prev, split: parseInt(e.target.value)}))}
        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500"
      />
      {formData.amount > 0 && (
         <div className="flex justify-between mt-2 text-[10px] text-gray-400">
            <span>{formatMoney(formData.amount * (formData.split/100))}</span>
            <span>{formatMoney(formData.amount * ((100-formData.split)/100))}</span>
         </div>
      )}
   </div>
)}

{/* ‡∏™‡πà‡∏ß‡∏ô Slider ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞) */}
{formData.type === 'installment' && (
   <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4">
      <div className="flex justify-between items-center mb-2">
         <label className="text-xs font-bold text-blue-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏ú‡πà‡∏≠‡∏ô</label>
         <span className="text-xl font-bold text-blue-700">{formData.months} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
      </div>
      <input 
         type="range" min="2" max="36" step="1" 
         value={formData.months} 
         onChange={(e) => setFormData(prev => ({...prev, months: parseInt(e.target.value)}))}
         className="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
      />
      {formData.amount > 0 && (
         <div className="text-right mt-2 text-xs font-bold text-blue-500">
            ‡∏ï‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ {formatMoney(formData.amount / formData.months)}
         </div>
      )}
   </div>
)}

{/* ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡πà‡∏≤‡∏¢ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô) */}
{formData.type === 'transfer' && activeInstallments && activeInstallments.length > 0 && (
   <div className="mb-4 animate-in slide-in-from-top-2">
      <label className="text-xs font-bold text-gray-500 mb-2 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</label>
      <div className="space-y-2 max-h-40 overflow-y-auto bg-gray-50 p-2 rounded-xl border border-gray-200">
         {activeInstallments.map(inst => {
            const paid = installmentProgress[inst.id] || 0;
            const perMonth = inst.amount / inst.months;
            const isSelected = formData.relatedInstallments && formData.relatedInstallments.some(x => x.id === inst.id);
            
            return (
               <div key={inst.id} 
                  onClick={() => {
                     let newRelated;
                     const currentAmount = parseFloat(formData.amount) || 0;
                     if (isSelected) {
                        newRelated = formData.relatedInstallments.filter(x => x.id !== inst.id);
                        setFormData(prev => ({ ...prev, relatedInstallments: newRelated, amount: currentAmount - perMonth }));
                     } else {
                        newRelated = [...(formData.relatedInstallments || []), inst];
                        setFormData(prev => ({ ...prev, relatedInstallments: newRelated, amount: currentAmount + perMonth }));
                     }
                  }}
                  className={`flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all ${isSelected ? 'bg-orange-100 border-orange-300 ring-1 ring-orange-300' : 'bg-white border-gray-200 hover:border-orange-200'}`}
               >
                  <div className="flex items-center gap-3">
                     <div className={`w-5 h-5 rounded flex items-center justify-center border transition-colors ${isSelected ? 'bg-orange-500 border-orange-500' : 'bg-white border-gray-300'}`}>
                        {isSelected && <CheckCircle2 className="w-3.5 h-3.5 text-white" />}
                     </div>
                     <div>
                        <p className="text-xs font-bold text-gray-700">{inst.title}</p>
                        <p className="text-[10px] text-gray-400">‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà {paid + 1}/{inst.months}</p>
                     </div>
                  </div>
                  <span className="text-sm font-bold text-gray-800">{formatMoney(perMonth)}</span>
               </div>
            );
         })}
      </div>
   </div>
)}

                    {formData.type !== 'transfer' && (
                      <div>
                        <label className="text-xs font-bold text-gray-500 mb-1 flex justify-between">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <span className="text-orange-400 font-normal flex items-center gap-1"><Sparkles className="w-3 h-3"/> Auto-Tag</span></label>
                        <input 
                           type="text" 
                           name="title" 
                           list="history-titles" 
                           value={formData.title} 
                           onChange={handleInputChange} 
                           className="w-full bg-gray-50 border-gray-200 border rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-orange-500" 
                           placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß, ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô..." 
                           required 
                           autoComplete="off" 
                        />
                        <datalist id="history-titles">
                           {historyTitles.map((t, i) => <option key={i} value={t} />)}
                        </datalist>
                      </div>
                    )}
                    
{/* 1. ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic Max Limit) */}
   <div>
      <label className="text-xs font-bold text-gray-500 mb-1 block text-center">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
      <div className="relative">
         <input 
            type="number" 
            name="amount" 
            value={formData.amount} 
            max={
               formData.type === 'transfer' && formData.payer && calculation.adjustedPrevStats[formData.payer]
               ? (() => {
                  // 1. ‡∏´‡∏≤‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏î‡∏¥‡∏° (Existing Debt)
                  let currentNet = calculation.adjustedPrevStats[formData.payer].netBalance;
                  
                  // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏´‡πâ‡∏ö‡∏ß‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á
                  if (editingId) {
                     const originalItem = expenses.find(e => e.id === editingId);
                     if (originalItem && originalItem.type === 'transfer' && originalItem.payer === formData.payer) {
                        currentNet -= originalItem.amount;
                     }
                  }
                  
                  // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏•‡∏ö = ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡∏µ‡πâ, ‡∏ñ‡πâ‡∏≤‡∏ö‡∏ß‡∏Å = 0)
                  const debtAmount = currentNet < 0 ? Math.abs(currentNet) : 0;

                  // 2. ‡∏´‡∏≤‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ (Installment Amount)
                  let installmentTotal = 0;
                  if (formData.relatedInstallments && formData.relatedInstallments.length > 0) {
                      installmentTotal = formData.relatedInstallments.reduce((sum, item) => sum + (item.amount / item.months), 0);
                  }

                  // 3. ‡πÄ‡∏≠‡∏≤ "‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πà‡∏≤" + "‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ" ‡∏°‡∏≤‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô Max Limit
                  return debtAmount + installmentTotal;
               })()
               : undefined
            }
            onChange={handleInputChange} 
            className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-center font-bold text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500 transition-all placeholder-gray-400" 
            placeholder="0.00" 
            required 
         />
         <span className="absolute right-4 top-1/2 -translate-y-1/2 text-xs font-bold text-gray-400 pointer-events-none">THB</span>
      </div>
      
      {/* ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) */}
      {formData.type === 'transfer' && formData.payer && calculation.adjustedPrevStats[formData.payer]?.netBalance < 0 && (
         <div className="mt-2 bg-red-50 border border-red-100 rounded-lg p-2 flex items-center justify-center gap-2 animate-in fade-in slide-in-from-top-2">
            <AlertTriangle className="w-4 h-4 text-red-500" />
            <span className="text-xs text-red-600 font-bold">
               ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤: {formatMoney(Math.abs(calculation.adjustedPrevStats[formData.payer].netBalance))}
            </span>
         </div>
      )}
   </div>

   {/* 2. ‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà) */}
   <div>
      <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <div className="relative">
         <input 
            type="date" 
            name="date" 
            value={formData.date} 
            onChange={handleInputChange} 
            className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 pl-10 text-gray-700 font-medium focus:outline-none focus:ring-2 focus:ring-orange-500 transition-all" 
         />
         <Calendar className="w-4 h-4 text-gray-400 absolute left-3 top-3.5 pointer-events-none"/>
      </div>
   </div>
<div>
                       <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                       {/* üëá ‡πÄ‡∏≠‡∏≤ input number ‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô üëá */}
                       <input 
                          type="text" 
                          name="note" 
                          value={formData.note} 
                          onChange={handleInputChange} 
                          className="w-full bg-gray-50 border border-gray-200 border rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-orange-500" 
                          placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" 
                       />
                    </div>
                    <div>
                       <label className="text-xs font-bold text-gray-500 mb-1 flex items-center gap-1"><Paperclip className="w-3 h-3"/> ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ/‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)</label>
                       <div className="border-2 border-dashed border-gray-200 rounded-xl p-4 text-center hover:bg-gray-50 transition-colors relative">
                          <input type="file" multiple accept="image/*,application/pdf" onChange={handleFileChange} className="absolute inset-0 opacity-0 cursor-pointer" />
                          <div className="flex flex-col items-center gap-1 text-gray-400">
                             <Upload className="w-6 h-6"/>
                             <span className="text-xs">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠ PDF</span>
                          </div>
                       </div>
                       {formData.attachments && formData.attachments.length > 0 && (
                          <div className="mt-2 space-y-2">
                             {formData.attachments.map((att, idx) => (
                                <div key={idx} className="flex items-center justify-between bg-gray-50 p-2 rounded-lg border border-gray-100">
                                   <div className="flex items-center gap-2 overflow-hidden">
                                      {att.type.startsWith('image/') ? <ImageIcon className="w-4 h-4 text-blue-500 flex-shrink-0"/> : <FileText className="w-4 h-4 text-red-500 flex-shrink-0"/>}
                                      <span className="text-xs text-gray-600 truncate max-w-[150px]">{att.name}</span>
                                   </div>
                                   <button type="button" onClick={() => removeAttachment(idx)} className="text-red-400 hover:text-red-600"><X className="w-4 h-4"/></button>
                                </div>
                             ))}
                          </div>
                       )}
                    </div>

                    {formData.type !== 'transfer' && (
                       <div>
                          <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                          <div className="relative">
                            <select name="category" value={formData.category} onChange={handleInputChange} className="w-full bg-gray-50 border-gray-200 border rounded-xl p-3 appearance-none focus:outline-none focus:ring-2 focus:ring-orange-500">
                               {categories.map(c => <option key={c} value={c}>{c}</option>)}
                             </select>
                            <Tag className="w-4 h-4 text-gray-400 absolute right-3 top-3.5 pointer-events-none"/>
                          </div>
                       </div>
                    )}
                    <div>
                       <label className="text-xs font-bold text-gray-500 mb-1 block">{formData.type === 'transfer' ? '‡∏Ñ‡∏ô‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' : '‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô'}</label>
                       <div className="flex gap-2">
                          {users.map(u => (
                             <button key={u.id} type="button" onClick={() => setFormData(prev => ({...prev, payer: u.name}))} className={`flex-1 py-3 rounded-xl border font-bold text-sm transition-all ${formData.payer === u.name ? 'border-orange-500 bg-orange-50 text-orange-700' : 'border-gray-200 text-gray-500'}`}>{u.name}</button>
                          ))}
                       </div>
                    </div>


                    <button type="submit" className="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-3.5 rounded-xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                  </form>
                </div>
              </div>
            )}

{isUserModalOpen && (
               <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                  <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
                     <h2 className="text-lg font-bold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                     <form onSubmit={handleUserSubmit} className="space-y-4">
                        <input type="text" value={userFormData.name} onChange={e => setUserFormData({...userFormData, name: e.target.value})} className="w-full border p-2 rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠" required/>
                        
                        {/* üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏£‡∏±‡∏ö placeholder ‡πÉ‡∏´‡πâ‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ */}
                        <input 
                            type="text" // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô text ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ , ‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å
                            value={userFormData.email} 
                            onChange={e => setUserFormData({...userFormData, email: e.target.value})} 
                            className="w-full border p-2 rounded-lg" 
                            placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡πÄ‡∏ä‡πà‡∏ô a@gmail.com, b@hotmail.com)" 
                        />
                        
                        <button type="submit" className="w-full bg-orange-500 text-white py-2 rounded-lg font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button type="button" onClick={() => setIsUserModalOpen(false)} className="w-full text-gray-400 text-xs mt-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                     </form>
                  </div>
               </div>
            )}
            {isCategoryModalOpen && (
               <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                  <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
                     <h2 className="text-lg font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h2>
                     <form onSubmit={handleCategorySubmit} className="space-y-4">
                        <input type="text" value={categoryFormData} onChange={e => setCategoryFormData(e.target.value)} className="w-full border p-2 rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà" required/>
                        <button type="submit" className="w-full bg-orange-500 text-white py-2 rounded-lg font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                        <button type="button" onClick={() => setIsCategoryModalOpen(false)} className="w-full text-gray-400 text-xs mt-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                     </form>
                  </div>
               </div>
            )}

            {showBudgetConfig && (
               <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                  <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
                     <div className="flex justify-between items-center mb-4"><h3 className="font-bold">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô</h3><button onClick={() => setShowBudgetConfig(false)}><X className="w-5 h-5"/></button></div>
                     <div className="space-y-4 max-h-[60vh] overflow-y-auto">
                        {budgetRules.map((rule) => (
                           <div key={rule.id} className="border p-3 rounded-xl bg-gray-50 text-sm">
                              <div className="flex justify-between mb-2">
                                 <select value={rule.category} onChange={e => updateRules(budgetRules.map(r => r.id === rule.id ? {...r, category: e.target.value} : r))} className="font-bold bg-transparent">{categories.map(c => <option key={c} value={c}>{c}</option>)}</select>
                                 <input type="number" value={rule.limit} onChange={e => updateRules(budgetRules.map(r => r.id === rule.id ? {...r, limit: parseFloat(e.target.value)} : r))} className="w-20 text-right border rounded px-1"/>
                              </div>
                              <div className="space-y-2">
                                 <div className="flex justify-between"><span>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á:</span><select value={rule.owner} onChange={e => updateRules(budgetRules.map(r => r.id === rule.id ? {...r, owner: e.target.value} : r))}>{users.map(u => <option key={u.id} value={u.name}>{u.name}</option>)}</select></div>
                                 <div className="flex justify-between"><span>‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô:</span><select value={rule.excessPayer} onChange={e => updateRules(budgetRules.map(r => r.id === rule.id ? {...r, excessPayer: e.target.value} : r))}>{users.map(u => <option key={u.id} value={u.name}>{u.name}</option>)}</select></div>
                              </div>
                              <button onClick={() => updateRules(budgetRules.filter(r => r.id !== rule.id))} className="text-red-500 text-xs mt-2 flex items-center gap-1"><MinusCircle className="w-3 h-3"/> ‡∏•‡∏ö</button>
                           </div>
                        ))}
                        <button onClick={() => updateRules([...budgetRules, { id: Date.now(), category: categories[0], limit: 1000, owner: users[0].name, excessPayer: users[1].name }])} className="w-full py-2 bg-gray-100 rounded-lg text-sm font-bold flex justify-center gap-2"><PlusCircle className="w-4 h-4"/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏é</button>
                     </div>
                     <button onClick={() => setShowBudgetConfig(false)} className="w-full mt-4 bg-orange-500 text-white font-bold py-2 rounded-xl">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                  </div>
               </div>
            )}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
